import sys
import os
import argparse


def parse_args():
    parser = argparse.ArgumentParser()

    parser.add_argument(
        "--model-name", help="name of the NN model", required=True)
    parser.add_argument(
        "--caffemodel", help="Path to the Caffe model file", required=True)
    parser.add_argument(
        "--prototxts", type=str, metavar="dir", nargs='+',
        help="a list of paths to prototxt files in pipeline stage order")
    '''
    parser.add_argument(
        "--prototxt", help="Path to the Caffe prototxt")
    parser.add_argument(
        "--split-at", type=str, metavar="var", nargs='+',
        help="a list of blob names in the provided prototxt so that the upstream "
        "and downstream will be split into separate pipeline stages")
    '''
    parser.add_argument(
        "--nvdla-compiler", default="/usr/local/nvdla/compiler/nvdla_compiler",
        help="Path to NVDLA compiler")
    parser.add_argument(
        "--qemu-bin", default="/usr/local/nvdla/vp/aarch64_toplevel",
        help="Path to qemu binary. By default it is pointing to the self-built qemu binary. Set to "
             "/usr/local/nvdla/aarch64_toplevel if one wants to use the one provided in docker image")
    parser.add_argument(
        "--qemu-lua", default="/usr/local/nvdla/aarch64_nvdla.lua",
        help="Path to configuration file of running qemu. Using the one in docker image is ok.")
    parser.add_argument(
        "--out-dir", default="/home/nvdla/traces/lenet_pipeline/",
        help="directory to put the generated sc.log, register txn and mem traces")

    args = parser.parse_args()

    # check legal
    if len(args.prototxts) != 0:
        assert args.prototxt is None and args.split_at is None
    if args.prototxt is not None or args.split_at is not None:
        assert args.prototxt is not None and args.split_at is not None
    return args


def main():
    options = parse_args()
    num_stages = len(options.prototxts)
    work_dirs = []
    for i in range(num_stages):
        work_dir = os.path.join(os.path.abspath(options.out_dir), "stage_" + str(i + 1))
        work_dirs.append(work_dir)
        os.makedirs(work_dir, exist_ok=True)

        assert os.path.exists(options.prototxts[i])
        os.system("cp " + options.prototxts[i] + " " + work_dir)
        os.system("cd " + os.path.dirname(os.path.abspath(__file__)) +
                  " && python3 caffe2trace.py --model-name " + options.model_name +
                  "_stage_" + str(i + 1) + " --caffemodel " + os.path.abspath(options.caffemodel) + " --prototxt " +
                  os.path.abspath(options.prototxts[i]) +
                  " --nvdla-compiler " + os.path.abspath(options.nvdla_compiler) + " --qemu-bin " +
                  os.path.abspath(options.qemu_bin) + " --qemu-lua " + os.path.abspath(options.qemu_lua) +
                  " --out-dir " + work_dir)


if __name__ == "__main__":
    main()
